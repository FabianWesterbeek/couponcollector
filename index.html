<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Coupon Collector Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

  <div id="content">
    <h1>Coupon Collector Calculator</h1>
    <p>Enter a drop rate (e.g. "0.1" or "1/15"), the number of coupons (e.g. "24"), and rolls per loot. If you get a coupon on every try, enter "1".</p>
  
    <label for="droprate">Drop Rate:</label>
    <input type="text" id="droprate" placeholder="0.1 or 1/15" />
  
    <label for="coupons">Number of Coupons:</label>
    <input type="number" id="coupons" placeholder="24" />
  
    <label for="rollsPerLoot">Rolls per Loot:</label>
    <input type="number" id="rollsPerLoot" placeholder="1" value="1" />
  
    <button id="calculate">Calculate</button>
  
    <div id="result"></div>
  
    <h2>Explanation</h2>
    <p>
      Given a drop rate \( \frac{1}{r} \), \( n \) coupons, and rolls per loot, the expected number of tries to collect all coupons is given by:
      <a class="citation" href="https://www.cambridge.org/core/journals/journal-of-applied-probability/article/generalised-coupon-collector-problem/4D5F06A32A7C98F87277BC33E49CE5AE" target="_blank">[<span>1</span>]</a>:
    </p>
    <p>
      \[
         E[Y_n] = \frac{r \cdot n \sum_{i=1}^{n} \frac{1}{i}}{k},
      \]
      where \(k\) is the number of rolls per loot.
    </p>
  </div>
  
  <div id="unequalContent">
    <h2>Unequal Probabilities Coupon Collector Calculator</h2>
    <p>Enter probabilities (comma-separated) that sum to 1. For example: "0.1,0.2,0.3,0.4". N must be ≤ 15.</p>
    <input type="text" id="probabilitiesInput" placeholder="0.1,0.2,0.3,0.4" />
    <button id="calculateUnequal">Calculate for Unequal Probabilities</button>
    <div id="unequalResult"></div>
  </div>
  
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById('calculate').addEventListener('click', function() {
      const droprateStr = document.getElementById('droprate').value.trim();
      const coupons = parseInt(document.getElementById('coupons').value.trim(), 10);
      const rollsPerLoot = parseInt(document.getElementById('rollsPerLoot').value.trim(), 10);
      const resultEl = document.getElementById('result');
      
      if (isNaN(coupons) || coupons <= 0) {
        resultEl.textContent = 'Please enter a valid number of coupons.';
        return;
      }
  
      if (isNaN(rollsPerLoot) || rollsPerLoot <= 0) {
        resultEl.textContent = 'Please enter a valid number of rolls per loot.';
        return;
      }
  
      let dropRate;
      if (droprateStr.includes('/')) {
        const [numStr, denStr] = droprateStr.split('/');
        const num = parseFloat(numStr);
        const den = parseFloat(denStr);
        if (isNaN(num) || isNaN(den) || den === 0) {
          resultEl.textContent = 'Invalid drop rate fraction.';
          return;
        }
        dropRate = num / den;
      } else {
        dropRate = parseFloat(droprateStr);
        if (isNaN(dropRate) || dropRate <= 0) {
          resultEl.textContent = 'Invalid drop rate. Please enter a positive number.';
          return;
        }
      }
  
      let harmonicSum = 0;
      for (let i = 1; i <= coupons; i++) {
        harmonicSum += (coupons / i);
      }
  
      const expectedTries = (harmonicSum / dropRate) / rollsPerLoot;
      const roundedTries = expectedTries.toFixed(2);
      resultEl.textContent = `Expected number of tries: ${roundedTries}`;
    });

    // Helper to get combinations of indices
    function getCombinations(arr, k) {
      let results = [];
      function backtrack(start, combo) {
        if (combo.length === k) {
          results.push(combo.slice());
          return;
        }
        for (let i = start; i < arr.length; i++) {
          combo.push(arr[i]);
          backtrack(i+1, combo);
          combo.pop();
        }
      }
      backtrack(0, []);
      return results;
    }

    // Unequal probabilities expectation calculation
    function unequalCaseExpectation(probabilities) {
      const sum = probabilities.reduce((a,b) => a+b, 0);
      if (Math.abs(sum - 1.0) > 1e-12) {
        throw new Error("Probabilities must sum to 1.");
      }

      const N = probabilities.length;
      if (N > 15) {
        throw new Error("N must be ≤ 15.");
      }

      let expectation = 0.0;
      const indices = [...Array(N).keys()];

      for (let k = 1; k <= N; k++) {
        const sign = (k % 2 === 1) ? 1 : -1;
        const subsets = getCombinations(indices, k);

        let partialSum = 0;
        for (const subset of subsets) {
          let subsetSum = 0;
          for (const idx of subset) {
            subsetSum += probabilities[idx];
          }
          partialSum += (1.0 / subsetSum);
        }

        expectation += sign * partialSum;
      }

      return expectation;
    }

    document.getElementById('calculateUnequal').addEventListener('click', function() {
      const inputStr = document.getElementById('probabilitiesInput').value.trim();
      const resultEl = document.getElementById('unequalResult');

      if (!inputStr) {
        resultEl.textContent = "Please enter probabilities.";
        return;
      }

      let probabilities = inputStr.split(',').map(p => parseFloat(p.trim())).filter(x => !isNaN(x));

      if (probabilities.length === 0) {
        resultEl.textContent = "Invalid input.";
        return;
      }

      try {
        const expectation = unequalCaseExpectation(probabilities);
        resultEl.textContent = `Expected number of tries (unequal probabilities): ${expectation.toFixed(4)}`;
      } catch (e) {
        resultEl.textContent = e.message;
      }
    });

  });
  </script>
  
</body>
</html>
